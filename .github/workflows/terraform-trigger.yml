name: Terraform Metrics Collection

on:
  push:
    paths:
      - '**.tf'
  pull_request:
    paths:
      - '**.tf'

jobs:
  collect-metrics:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for context
      
      - name: Download previous metrics (if exists)
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: metrics-history
          path: .
      
      - name: Build Docker image
        run: docker build -t tf-metrics:latest .
      
      - name: Collect metrics for this commit
        run: |
          if [ -f "metrics.csv" ]; then
            echo "Using historical context from previous metrics"
            docker run \
              -v ${{ github.workspace }}:/repo \
              tf-metrics:latest /repo \
              --commit ${{ github.sha }} \
              --history /repo/metrics.csv
          else
            echo "No historical context available, running without history"
            docker run \
              -v ${{ github.workspace }}:/repo \
              tf-metrics:latest /repo \
              --commit ${{ github.sha }}
          fi
      
      - name: Rename output file
        run: |
          if [ -f "metrics_history.csv" ]; then
            mv metrics_history.csv metrics.csv
          fi
      
      - name: Upload metrics as artifact
        uses: actions/upload-artifact@v4
        with:
          name: metrics-history
          path: metrics.csv
          retention-days: 90
      
      - name: Display metrics summary
        run: |
          if [ -f "metrics.csv" ]; then
            echo "Metrics collected successfully"
            wc -l metrics.csv
            head -n 2 metrics.csv
          fi
