name: Metrics Collection (GitHub Artifacts)

on:
  push:
    paths:
      - '**.tf'
  pull_request:
    paths:
      - '**.tf'

jobs:
  collect-metrics:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Download previous metrics
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: metrics-history
          path: .
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: pip install -r requirements.txt
      
      - name: Rotate metrics if needed
        run: |
          if [ -f "metrics.csv" ]; then
            python scripts/storage_manager.py \
              --file metrics.csv \
              --max-size 10 \
              --keep-rows 500
          fi
      
      - name: Build Docker image
        run: docker build -t tf-metrics:latest .
      
      - name: Collect metrics for this commit
        run: |
          if [ -f "metrics.csv" ]; then
            echo "Using historical context"
            docker run \
              -v ${{ github.workspace }}:/repo \
              tf-metrics:latest /repo \
              --commit ${{ github.sha }} \
              --history /repo/metrics.csv
          else
            echo "No historical context available"
            docker run \
              -v ${{ github.workspace }}:/repo \
              tf-metrics:latest /repo \
              --commit ${{ github.sha }}
          fi
      
      - name: Rename output file
        run: |
          if [ -f "metrics_history.csv" ]; then
            mv metrics_history.csv metrics.csv
          fi
      
      - name: Upload active metrics
        uses: actions/upload-artifact@v4
        with:
          name: metrics-history
          path: metrics.csv
          retention-days: 90
      
      - name: Upload archives (if any)
        if: hashFiles('metrics_archive_*.csv') != ''
        uses: actions/upload-artifact@v4
        with:
          name: metrics-archives
          path: metrics_archive_*.csv
          retention-days: 365
      
      - name: Display summary
        run: |
          if [ -f "metrics.csv" ]; then
            echo "âœ“ Metrics collected successfully"
            echo "File size: $(du -h metrics.csv | cut -f1)"
            echo "Row count: $(wc -l < metrics.csv)"
          fi
