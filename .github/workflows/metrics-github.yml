name: Metrics Collection (GitHub Artifacts)

on:
  push:
    paths:
      - '**.tf'
  pull_request:
    paths:
      - '**.tf'

concurrency:
  group: metrics-collection-${{ github.ref }}
  cancel-in-progress: false

jobs:
  collect-metrics:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      
      - name: Download previous metrics (from last successful run)
        uses: dawidd6/action-download-artifact@v3
        continue-on-error: true
        with:
          workflow: metrics-github.yml
          name: metrics-history
          path: .
          if_no_artifact_found: warn
      
      
      - name: Check if history was downloaded
        run: |
          echo "=== Metrics History Status ==="
          if [ -f "metrics.csv" ]; then
            echo "✓ Historical metrics found"
            echo "  Total rows: $(wc -l < metrics.csv)"
            echo "  File size: $(du -h metrics.csv | cut -f1)"
            echo "  Last modified: $(stat -c %y metrics.csv 2>/dev/null || stat -f %Sm metrics.csv)"
            echo ""
            echo "Preview (first 3 rows):"
            head -n 3 metrics.csv
          else
            echo "⚠ No historical metrics found"
            echo "  This is the first run or artifact expired"
          fi
          echo "==========================="
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: pip install -r requirements.txt
      
      - name: Rotate metrics if needed
        run: |
          if [ -f "metrics.csv" ]; then
            python scripts/storage_manager.py \
              --file metrics.csv \
              --max-size 10 \
              --keep-rows 500
          fi
      
      - name: Build Docker image
        run: docker build -t tf-metrics:latest .
      
      - name: Collect metrics for this commit
        run: |
          set -e  # Exit on error
          if [ -f "metrics.csv" ]; then
            echo "Using historical context"
            echo "History file size: $(du -h metrics.csv | cut -f1)"
            docker run \
              -v ${{ github.workspace }}:/repo \
              -w /repo \
              tf-metrics:latest . \
              --commit ${{ github.sha }} \
              --history metrics.csv
            echo "Docker run completed with exit code: $?"
          else
            echo "No historical context available"
            docker run \
              -v ${{ github.workspace }}:/repo \
              -w /repo \
              tf-metrics:latest . \
              --commit ${{ github.sha }}
            echo "Docker run completed with exit code: $?"
          fi
          echo "Listing files after Docker run:"
          ls -la *.csv 2>/dev/null || echo "No CSV files found"
      
      - name: Debug - List CSV files
        run: |
          echo "=== Listing all CSV files in workspace ==="
          ls -la *.csv 2>/dev/null || echo "No CSV files found in root"
          echo "=== Checking for specific files ==="
          [ -f "metrics_history.csv" ] && echo "✓ metrics_history.csv exists" || echo "✗ metrics_history.csv NOT found"
          [ -f "metrics.csv" ] && echo "✓ metrics.csv exists" || echo "✗ metrics.csv NOT found"
          [ -f "metrics_new_instance.csv" ] && echo "✓ metrics_new_instance.csv exists" || echo "✗ metrics_new_instance.csv NOT found"
      
      - name: Rename output file
        run: |
          if [ -f "metrics_history.csv" ]; then
            echo "Found metrics_history.csv, renaming to metrics.csv"
            mv metrics_history.csv metrics.csv
          elif [ -f "metrics_new_instance.csv" ]; then
            echo "Found metrics_new_instance.csv, renaming to metrics.csv"
            mv metrics_new_instance.csv metrics.csv
          elif [ ! -f "metrics.csv" ]; then
            echo "ERROR: No metrics file found!"
            echo "Creating empty file to prevent upload failure"
            touch metrics.csv
            exit 1
          else
            echo "metrics.csv already exists, using it"
          fi
      
      - name: Upload active metrics
        if: success() || failure()
        uses: actions/upload-artifact@v4
        with:
          name: metrics-history
          path: metrics.csv
          retention-days: 90
      
      - name: Upload archives (if any)
        if: hashFiles('metrics_archive_*.csv') != ''
        uses: actions/upload-artifact@v4
        with:
          name: metrics-archives
          path: metrics_archive_*.csv
          retention-days: 365
      
      - name: Display summary
        if: success()
        run: |
          if [ -f "metrics.csv" ] && [ -s "metrics.csv" ]; then
            echo "✓ Metrics collected successfully"
            echo "File size: $(du -h metrics.csv | cut -f1)"
            echo "Row count: $(wc -l < metrics.csv)"
            echo "=== First 3 lines ==="
            head -n 3 metrics.csv
          else
            echo "⚠ metrics.csv is empty or missing"
          fi
