name: Defect Prediction

on:
  workflow_run:
    workflows: ["Metrics Collection (S3 Storage)"]
    types: [completed]
    branches: [main]
  workflow_dispatch:  # Allow manual trigger for testing

env:
  S3_BUCKET: ${{ secrets.METRICS_S3_BUCKET }}
  S3_PREFIX: metrics

jobs:
  predict:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    permissions:
      contents: read
      packages: read
      pull-requests: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}
      
      - name: Download current metrics from S3
        run: |
          echo "Downloading current commit metrics from S3..."
          aws s3 cp \
            s3://${{ env.S3_BUCKET }}/${{ env.S3_PREFIX }}/metrics_current.csv \
            metrics_current.csv
          
          echo "âœ“ Metrics downloaded"
          echo "Rows in metrics_current.csv:"
          wc -l metrics_current.csv
          echo ""
          echo "Preview:"
          head -3 metrics_current.csv
      
      - name: Check if metrics file is empty
        id: check_metrics
        run: |
          row_count=$(wc -l < metrics_current.csv)
          if [ "$row_count" -le 1 ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "âš  No metrics to predict (file is empty or header only)"
          else
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "âœ“ Found $((row_count - 1)) blocks to analyze"
          fi
      
      - name: Log in to GitHub Container Registry
        if: steps.check_metrics.outputs.skip == 'false'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Pull ML Docker image
        if: steps.check_metrics.outputs.skip == 'false'
        run: |
          echo "Pulling ML Docker image..."
          # Try to pull ML image (will fail if not built yet)
          if docker pull ghcr.io/${{ github.repository }}-ml:latest 2>/dev/null; then
            echo "âœ“ ML image ready"
          else
            echo "âš  ML Docker image not available yet"
            echo "Please build the ML image first using the build-ml-image workflow"
            exit 1
          fi
      
      - name: Run defect prediction
        if: steps.check_metrics.outputs.skip == 'false'
        run: |
          echo "Running ML prediction on current commit metrics..."
          docker run \
            -v $(pwd):/data \
            -w /data \
            ghcr.io/${{ github.repository }}-ml:latest \
            predict \
            --csv /data/metrics_current.csv \
            --model random_forest_model \
            --output /data/predictions.csv
          
          echo "âœ“ Predictions generated"
          echo ""
          echo "Predictions:"
          cat predictions.csv
      
      - name: Upload predictions to S3
        if: steps.check_metrics.outputs.skip == 'false'
        run: |
          echo "Uploading predictions to S3..."
          aws s3 cp predictions.csv \
            s3://${{ env.S3_BUCKET }}/${{ env.S3_PREFIX }}/predictions_${{ github.sha }}.csv
          aws s3 cp predictions.csv \
            s3://${{ env.S3_BUCKET }}/${{ env.S3_PREFIX }}/predictions_latest.csv
          echo "âœ“ Predictions uploaded"
      
      - name: Comment on PR with predictions
        if: steps.check_metrics.outputs.skip == 'false' && github.event.workflow_run.event == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // Read predictions CSV
            const predictions = fs.readFileSync('predictions.csv', 'utf8');
            const lines = predictions.trim().split('\n');
            
            if (lines.length <= 1) {
              console.log('No predictions to post');
              return;
            }
            
            // Parse CSV (assuming: block_id,prediction,confidence,probability)
            const results = lines.slice(1).map(line => {
              const parts = line.split(',');
              return {
                block_id: parts[0],
                prediction: parseInt(parts[1]),
                probability: parseFloat(parts[3] || parts[2])  // Handle different column orders
              };
            }).filter(r => !isNaN(r.probability));
            
            // Group by risk level
            const highRisk = results.filter(r => r.probability > 0.7);
            const mediumRisk = results.filter(r => r.probability >= 0.4 && r.probability <= 0.7);
            const lowRisk = results.filter(r => r.probability < 0.4);
            
            // Build comment
            let comment = '## ðŸ¤– Defect Prediction Results\n\n';
            
            if (highRisk.length > 0) {
              comment += '### âš ï¸ High Risk Blocks (>70% defect probability)\n';
              highRisk.forEach(r => {
                comment += `- \`${r.block_id}\` - **${(r.probability * 100).toFixed(0)}%** likely defective\n`;
              });
              comment += '\n';
            }
            
            if (mediumRisk.length > 0) {
              comment += '### âš¡ Medium Risk Blocks (40-70%)\n';
              mediumRisk.forEach(r => {
                comment += `- \`${r.block_id}\` - ${(r.probability * 100).toFixed(0)}%\n`;
              });
              comment += '\n';
            }
            
            if (lowRisk.length > 0) {
              comment += `### âœ… Low Risk Blocks (<40%): ${lowRisk.length} blocks\n\n`;
            }
            
            comment += `**Total blocks analyzed:** ${results.length}\n\n`;
            
            if (highRisk.length > 0) {
              comment += '**âš ï¸ Recommendation:** Review high-risk blocks carefully before merging.\n';
            } else if (mediumRisk.length > 0) {
              comment += '**âœ“ Recommendation:** Medium-risk blocks detected. Consider review.\n';
            } else {
              comment += '**âœ… Recommendation:** All blocks look good!\n';
            }
            
            // Get PR number from workflow_run
            const prNumber = context.payload.workflow_run.pull_requests[0]?.number;
            
            if (prNumber) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: comment
              });
              console.log(`Posted prediction results to PR #${prNumber}`);
            } else {
              console.log('No PR found, skipping comment');
              console.log(comment);
            }
      
      - name: Summary
        if: always()
        run: |
          if [ "${{ steps.check_metrics.outputs.skip }}" == "true" ]; then
            echo "âš  No predictions made (no metrics to analyze)"
          else
            echo "âœ… Prediction workflow completed"
            echo "Check PR for defect prediction results"
          fi
